<div class="container">
  <div class="row justify-content-center mt-1">
    <!-- Activity Image Carousel -->
    <div class="col-12">
      <div id="activityImageCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <!-- Check if there are any photos; if not, display the default image -->
          <% if @activity.photos.present? %>
            <% @activity.photos.each_with_index do |photo, index| %>
              <div class="carousel-item <%= index == 0 ? 'active' : '' %>">
                <!-- Display activity image using Cloudinary's 'cl_image_tag' helper -->
                <%= cl_image_tag photo.key, class: "carousel-image" %>
              </div>
            <% end %>
          <% else %>
            <!-- Use the default photo when no photos are available -->
            <div class="carousel-item active">
              <%= image_tag "bar.png", class: "carousel-image", alt: "Default Activity Photo" %>
            </div>
          <% end %>
        </div>

        <!-- Carousel navigation buttons (Previous and Next) -->
        <button class="carousel-control-prev" type="button" data-bs-target="#activityImageCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#activityImageCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" ariahidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>
    </div>

    <!-- Description -->
    <div class="row">
      <div class="col-12">
        <div class="card mt-2 m-0 mb-2">
          <div class="card-body">
            <!-- Activity Description -->
            <div class="description-container costum--container">
              <% if @activity.present? %>
                <h4 class="card-title my-1"><%= @activity.name %></h4>
                <p class="card-text mt-2 mb-2">
                  <strong>Activity Creator:</strong> <%= @activity.owner.first_name %>
                  <br>
                  <strong>Participants:</strong>
                  <% @activity.participants.shuffle.first(5).each do |participant| %>
                    <%= participant.first_name %>,
                  <% end %>
                </p>
                <%= link_to "Join", activity_path(@activity), class: "btn btn-primary" %>
              <% else %>
                <p>Activity details</p>
              <% end %>
            </div>
            
            <!-- Join Button -->
            <% if current_user == @activity.owner %> <!-- If the current user is the activity owner -->
               <!-- Chatroom link -->
              <%= link_to "Chatroom", chatroom_path(@chatroom), class: "btn btn-primary" %>
            <% elsif @activity_booked %>
              <%= link_to "Chatroom", chatroom_path(@chatroom), class: "btn btn-primary" %>
              <%= link_to "Leave", booking_path(@activity_booked), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger link-btn delete-edit" %>
            <% elsif @activity_pending %>
              <p>Waiting for approval</p>
              <%= link_to "Cancel", booking_path(@activity_pending), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger link-btn delete-edit" %>
            <% elsif @activity_declined %>
              <p>Declined</p>
            <% else %>
              <%= simple_form_for [@activity, @booking] do |f| %>
                <%= f.submit "Join", class: "btn btn-primary" %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full Address -->
  <div class="row my-0 mb-0">
    <div class="col-12">
      <p><%= @activity.address %></p>
    </div>
  </div>

  <!-- Map -->
  <div class="row my-0 mt-0">
    <div class="col-12">
      <!-- Mapbox container and data attributes -->
      <div class="map-container"
           data-controller="map"
           data-map-markers-value="<%= @markers.to_json %>"
           data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
      </div>
    </div>
  </div>
  
  <!-- Message Box -->
  <!-- Display message box to activity owner or activity participants -->
  <% if @activity_booked || current_user == @activity.owner %>
    <%= render partial: "chatroom", locals: { activity: @activity, chatroom: @chatroom, message: @message } %>
  <% end %>
</div>

<!-- Display additional activities -->
<div class="container">
  <div class="row justify-content-center mt-4">
    <div class="col-12">
      <h3>Similar Activities</h3>
      <div class="row">
        <% @activities.each do |activity| %>
          <div class="col-12 col-md-4 mb-4">
            <%= link_to activity_path(activity) do %> <!-- Wrap the entire card content in a link -->
              <div class="card">
                <div class="card-body">
                  <!-- Activity Image -->
                  <% if activity.photos.present? %>
                    <%= cl_image_tag activity.photos.first.key, class: "card-img-top", alt: "Activity Photo" %>
                  <% else %>
                    <!-- Use a default image if no photos are available -->
                    <%= image_tag "bar.png", class: "card-img-top", alt: "Default Activity Photo" %>
                  <% end %>

                  <!-- Activity Details -->
                  <h5 class="card-title"><strong><%= activity.name %></strong></h5>
                  <p class="card-text"><%= activity.description %></p>

                  <!-- Join Button -->
                  <% if current_user == activity.owner %>
                    <%= link_to "Edit", edit_activity_path(activity), class: "btn btn-primary" %>
                  <% else %>
                    <%= simple_form_for [activity, Booking.new] do |f| %>
                      <%= f.submit "Join", class: "btn btn-primary" %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            <% end %> <!-- Close the link here -->
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<h1>Your activity dashboard</h1>

<!--Activities you own-->
<div class="section">
  <h2>My organized activities (<%= @my_activities.count %>)</h2>
  <% @my_activities.each do |activity| %>
    <%= link_to activity_path(activity) do %>
      <ul>
        <li>
          <h3 class="section-title"><%= activity.name %></h3>
            <h5><%= activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M') %></h5>
            <h5><%= activity.address %></h5>
          <div class="option-select-btn">
            <%= link_to "Delete", activity_path(activity), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger link-btn delete-edit" %>
            <%= link_to "Edit", edit_activity_path(activity), class: "btn btn-outline-primary link-btn delete-edit m-1" %>
          </div>
        </li>
      </ul>
    <% end %>
  <% end %>
</div>

<!--Activities you book as participant-->
<div class="section">
  <h2>My bookings (<%= @my_bookings.count %>)</h2>
  <% unique_activities = @my_bookings.map(&:activity).uniq %>
  <% unique_activities.each do |activity| %>
    <% bookings = @my_bookings.select { |booking| booking.activity == activity } %>
    <% booking = bookings.first %>
    <%= link_to booking_path(booking) do %>
      <ul>
        <li>
          <h3 class="section-title"><%= activity.name %></h3>
          <h5><%= activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M') %><h5>
          <h5><%= activity.address %></h5>
            <h5 class="status-text">Status:
            <% if booking.status == nil %>
              <%= "Pending" %>
            <% elsif booking.status == false %>
              <%= "Declined" %>
            <% else %>
              <%= "Approved" %>
            <% end %>
          </h5>
          <div class="option-select-btn mt-1">
            <%= link_to "Delete", booking_path(booking.id), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" }, class: "btn btn-outline-danger link-btn delete-edit" %>
          </div>
        </li>
      </ul>
    <% end %>
  <% end %>
</div>

<!-- Activities booked by participants that you approved -->
<div class="section">
  <h2>Booked by Participants</h2>
  <% grouped_activities = @participants_booked.group_by { |booked| [booked.activity.name, booked.activity.date_time] } %>
  <% grouped_activities.each do |(activity_name, activity_date_time), bookings| %>
    <%= link_to activity_path(bookings.first.activity) do %>
      <ul>
        <li>
          <h3 class="section-title"><%= activity_name %></h3>
          <h5><%= "#{activity_date_time.strftime('%^a, %d %^b, %Y at %H:%M')}" %></h5>
          <ol>
            <h4><% unique_participants = bookings.map { |booked| [booked.participant.first_name, booked.participant.last_name] }.uniq %></h4>
            <h4><% unique_participants.each do |participant| %></h4>
              <h4><li><%= "#{participant.join(' ')}" %></li></h4>
            <% end %>
          </ol>
        </li>
      </ul>
    <% end %>
  <% end %>
</div>

<!--Activities requested by participant that you declined-->
<div class="section">
  <h2>Declined Bookings</h2>
  <% declined_participants_by_activity = @participants_declined.group_by(&:activity) %>
  <% declined_participants_by_activity.each do |activity, declined_participants| %>
    <ul>
      <li>
        <h3 class="section-title"><%= activity.name %></h3>
        <h5><%= "#{activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M')}" %></h5>
        <ol>
          <h4><% unique_participants = declined_participants.map { |participant| "#{participant.participant.first_name} #{participant.participant.last_name}" }.uniq %></h4>
          <h4><% unique_participants.each do |participant_name| %></h4>
            <h4><li><%= participant_name %></li></h4>
          <% end %>
        </ol>
      </li>
    </ul>
  <% end %>
</div>

<!--Activities waiting for your review-->
<div class="section">
  <h2>Pending Bookings (<%=@participants_pending.count %>)</h2>
  <% @participants_pending.group_by(&:activity).each do |activity, participants| %>
    <%= link_to activity_path(activity) do %>
      <div class="pending-item">
        <ul>
          <li>
            <h3 class="section-title"><%= activity.name %></h3>
            <h5><%= "#{activity.date_time.strftime('%^a, %d %^b, %Y at %H:%M')}" %></h5>
            <h4>Requested by:</h4>
            <ol class="participants-list">
              <h4><% participants.map(&:participant).uniq.each do |participant| %></h4>
                <h4><li><%= "#{participant.first_name} #{participant.last_name}" %></li></h4>
              <% end %>
            </ol>
          </li>
        </ul>
      </div>
    <% end %>
  <% end %>

  <!--Display link to accept and decline page when there's an existing booking request-->
  <% if @participants_pending.empty? %>
    <h4>No booking yet</h4>
  <% else %>
  <div class="review-booking-button">
    <%= link_to "Review booking", bookings_path, class: "btn btn-primary review-button" %>
  <% end %>
  </div>
</div>
